define(function(t,e,n){"use strict";var i=t("riot-observable");var r=/^.+?\/+[^\/]+/,f="EventListener",o="remove"+f,u="add"+f,s="hasAttribute",c="replace",a="popstate",h="trigger",l=3,p=window,d=document,m=p.history.location||p.location,v=L.prototype,y=d&&d.ontouchstart?"touchstart":"click",b=false,g=i(),w=false,$,x,A,K,N=[],E=0,O,S=[];function k(t){return t.split(/[\/?#]/)}function q(t,e){var n=new RegExp("^"+e[c](/\*/g,"([^/?#]+?)")[c](/\.\./,".*")+"$"),i=t.match(n);if(i)return i.slice(1)}function D(t){p[u](a,z);d[u](y,B);if(t)z(true)}function L(){this.$=[];i(this);g.on("stop",this.s.bind(this));g.on("emit",this.e.bind(this))}function P(t){return t[c](/^\/|\/$/,"")}function R(t){return typeof t=="string"}function T(t){return(t||m.href)[c](r,"")}function j(t){return $[0]=="#"?(t||m.href).split($)[1]||"":T(t)[c]($,"")}function z(t){var e=E==0;if(l<=E)return;E++;N.push(function(){var e=j();if(t||e!=x){g[h]("emit",e);x=e}});if(e){while(N.length){N[0]();N.shift()}E=0}}function B(t){if(t.which!=1||t.metaKey||t.ctrlKey||t.shiftKey||t.defaultPrevented)return;var e=t.target;while(e&&e.nodeName!="A")e=e.parentNode;if(!e||e.nodeName!="A"||e[s]("download")||!e[s]("href")||e[s]("target")||e.href.indexOf(m.href.match(r)[0])==-1)return;if(e.href!=m.href){if(e.href.split("#")[0]==m.href.split("#")[0]||$!="#"&&T(e.href).indexOf($)!==0||!C(j(e.href),e.title||d.title))return}t.preventDefault()}function C(t,e){while(O=S.shift())O.apply(null);e=e||d.title;history.pushState(null,e,$+P(t));d.title=e;w=false;z();return w}v.m=function(t,e,n){if(R(t)&&(!e||R(e)))C(t,e);else if(typeof t==="function"&&e)this.r("@",t,e);else if(e)this.r(t,e,n);else this.r("@",t,e)};v.s=function(){this.off("*");this.$=[]};v.e=function(t){this.$.concat("@").some(function(e){var n=(e=="@"?A:K)(P(t),P(e));if(n){this[h].apply(null,[e].concat(n));return w=true}},this)};v.r=function(t,e,n){if(t!="@"){t="/"+P(t);this.$.push(t)}this.on(t,function(){if(typeof n==="function")S.push(n);e.apply(this,arguments)}.bind(this))};var F=new L;var G=F.m.bind(F);G.create=function(){var t=new L;t.m.stop=t.s.bind(t);return t.m.bind(t)};G.base=function(t){$=t||"#";x=j()};G.exec=function(){z(true)};G.parser=function(t,e){if(!t&&!e){A=k;K=q}if(t)A=t;if(e)K=e};G.query=function(){var t={};m.href[c](/[?&](.+?)=([^&]*)/g,function(e,n,i){t[n]=i});return t};G.stop=function(){if(b){p[o](a,z);d[o](y,B);g[h]("stop");b=false;S=[]}};G.start=function(t){if(!b){if(document.readyState=="complete")D(t);else p[u]("load",function(){setTimeout(function(){D(t)},1)});b=true}};G.base();G.parser();n.exports=G});